#ifndef H_KEYBOARD
#define H_KEYBOARD

void install_keyboard();
void flush_keyboard_queue(void);

unsigned char is_shifted();
unsigned char is_alted();

typedef struct {
    int key_number;
    char name[17];
    char is_pressed;
    char aff_min;
    char aff_maj;
    char aff_alt;
} key_t;

key_t *getch();

static key_t qwerty_us[132] = {
    {(0 << 5) | (0), "VOL_DOWN", 0, 0, 0, 0},
    {(0 << 5) | (1), "VOL_UP", 0, 0, 0, 0},
    {(0 << 5) | (2), "MIC_MUTE", 0, 0, 0, 0},
    {(0 << 5) | (3), "SPECIAL1", 0, 0, 0, 0},
    {(0 << 5) | (4), "SPECIAL2", 0, 0, 0, 0},
    {(1 << 5) | (0), "ESC", 0, 0, 0, 0},
    {(1 << 5) | (1), "F1", 0, 0, 0, 0},
    {(1 << 5) | (2), "F2", 0, 0, 0, 0},
    {(1 << 5) | (3), "F3", 0, 0, 0, 0},
    {(1 << 5) | (4), "F4", 0, 0, 0, 0},
    {(1 << 5) | (5), "F5", 0, 0, 0, 0},
    {(1 << 5) | (6), "F6", 0, 0, 0, 0},
    {(1 << 5) | (7), "F7", 0, 0, 0, 0},
    {(1 << 5) | (8), "F8", 0, 0, 0, 0},
    {(1 << 5) | (9), "F9", 0, 0, 0, 0},
    {(1 << 5) | (10), "F10", 0, 0, 0, 0},
    {(1 << 5) | (11), "F11", 0, 0, 0, 0},
    {(1 << 5) | (12), "F12", 0, 0, 0, 0},
    {(1 << 5) | (13), "SUPPR", 0, 0, 0, 0},
    {(1 << 5) | (14), "PAUSE", 0, 0, 0, 0},
    {(1 << 5) | (15), "IMPR ECR", 0, 0, 0, 0},
    {(1 << 5) | (16), "END", 0, 0, 0, 0},
    {(2 << 5) | (0), "GRAVE", 0, '`', '~', 0},
    {(2 << 5) | (1), "1", 0, '1', '!', 0},
    {(2 << 5) | (2), "2", 0, '2', '@', 0},
    {(2 << 5) | (3), "3", 0, '3', '#', 0},
    {(2 << 5) | (4), "4", 0, '4', '$', 0},
    {(2 << 5) | (5), "5", 0, '5', '%', 0},
    {(2 << 5) | (6), "6", 0, '6', '^', 0},
    {(2 << 5) | (7), "7", 0, '7', '&', 0},
    {(2 << 5) | (8), "8", 0, '8', '*', 0},
    {(2 << 5) | (9), "9", 0, '9', '(', 0},
    {(2 << 5) | (10), "0", 0, '0', ')', 0},
    {(2 << 5) | (11), "-", 0, '-', '_', 0},
    {(2 << 5) | (12), "=", 0, '=', '+', 0},
    {(2 << 5) | (13), "BACK SPACE", 0, '\b', '\b', '\b'},
    {(2 << 5) | (14), "NUM LOCK", 0, 0, 0, 0},
    {(2 << 5) | (15), "NUM /", 0, '/', '/', '/'},
    {(2 << 5) | (16), "NUM *", 0, '*', '*', '*'},
    {(2 << 5) | (17), "NUM -", 0, '-', '-', '-'},
    {(3 << 5) | (0), "TAB", 0, '\t', '\r', 0},
    {(3 << 5) | (1), "Q", 0, 'q', 'Q', 0},
    {(3 << 5) | (2), "W", 0, 'w', 'W', 0},
    {(3 << 5) | (3), "E", 0, 'e', 'E', 0},
    {(3 << 5) | (4), "R", 0, 'r', 'R', 0},
    {(3 << 5) | (5), "T", 0, 't', 'T', 0},
    {(3 << 5) | (6), "Y", 0, 'y', 'Y', 0},
    {(3 << 5) | (7), "U", 0, 'u', 'U', 0},
    {(3 << 5) | (8), "I", 0, 'i', 'I', 0},
    {(3 << 5) | (9), "O", 0, 'o', 'O', 0},
    {(3 << 5) | (10), "P", 0, 'p', 'P', 0},
    {(3 << 5) | (11), "[", 0, '[', '{', 0},
    {(3 << 5) | (12), "]", 0, ']', '}', 0},
    {(3 << 5) | (13), "\\", 0, '\\', '|', 0},
    {(3 << 5) | (14), "NUM 7", 0, '7', 0, '7'},
    {(3 << 5) | (15), "NUM 8", 0, '8', 0, '8'},
    {(3 << 5) | (16), "NUM 9", 0, '9', 0, '9'},
    {(3 << 5) | (17), "NUM +", 0, '+', '+', '+'},
    {(4 << 5) | (0), "CAPS LOCK", 0, 0, 0, 0},
    {(4 << 5) | (1), "A", 0, 'a', 'A', 0},
    {(4 << 5) | (2), "S", 0, 's', 'S', 0},
    {(4 << 5) | (3), "D", 0, 'd', 'D', 0},
    {(4 << 5) | (4), "F", 0, 'f', 'F', 0},
    {(4 << 5) | (5), "G", 0, 'g', 'G', 0},
    {(4 << 5) | (6), "H", 0, 'h', 'H', 0},
    {(4 << 5) | (7), "J", 0, 'j', 'J', 0},
    {(4 << 5) | (8), "K", 0, 'k', 'K', 0},
    {(4 << 5) | (9), "L", 0, 'l', 'L', 0},
    {(4 << 5) | (10), ";", 0, ';', ':', 0},
    {(4 << 5) | (11), "'", 0, '\'', '"', 0},
    {(4 << 5) | (12), "ENTER", 0, '\n', '\n', '\n'},
    {(4 << 5) | (13), "NUM 4", 0, '4', 0, '4'},
    {(4 << 5) | (14), "NUM 5", 0, '5', 0, '5'},
    {(4 << 5) | (15), "NUM 6", 0, '6', 0, '6'},
    {(5 << 5) | (0), "L SHIFT", 0, 0, 0, 0},
    {(5 << 5) | (1), "L SHIFT", 0, 0, 0, 0},
    {(5 << 5) | (2), "Z", 0, 'z', 'Z', 0},
    {(5 << 5) | (3), "X", 0, 'x', 'X', 0},
    {(5 << 5) | (4), "C", 0, 'c', 'C', 0},
    {(5 << 5) | (5), "V", 0, 'v', 'V', 0},
    {(5 << 5) | (6), "B", 0, 'b', 'B', 0},
    {(5 << 5) | (7), "N", 0, 'n', 'N', 0},
    {(5 << 5) | (8), "M", 0, 'm', 'M', 0},
    {(5 << 5) | (9), ",", 0, ',', '<', 0},
    {(5 << 5) | (10), ".", 0, '.', '>', 0},
    {(5 << 5) | (11), "/", 0, '/', '?', 0},
    {(5 << 5) | (12), "R SHIFT", 0, 0, 0, 0},
    {(5 << 5) | (14), "NUM 1", 0, '1', 0, '1'},
    {(5 << 5) | (15), "NUM 2", 0, '2', 0, '2'},
    {(5 << 5) | (16), "NUM 3", 0, '3', 0, '3'},
    {(5 << 5) | (17), "NUM ENTER", 0, '\n', '\n', '\n'},
    {(6 << 5) | (0), "LEFT CTRL", 0, 0, 0, 0},
    {(6 << 5) | (1), "LEFT FN", 0, 0, 0, 0},
    {(6 << 5) | (2), "SUPER", 0, 0, 0, 0},
    {(6 << 5) | (3), "ALT", 0, 0, 0, 0},
    {(6 << 5) | (4), "SPACE", 0, ' ', ' ', ' '},
    {(6 << 5) | (5), "ALT GR", 0, 0, 0, 0},
    {(6 << 5) | (6), "RIGHT FN", 0, 0, 0, 0},
    {(6 << 5) | (7), "RIGHT CTRL", 0, 0, 0, 0},
    {(6 << 5) | (8), "LEFT", 0, 0, 0, 0},
    {(6 << 5) | (9), "UP", 0, 0, 0, 0},
    {(6 << 5) | (10), "RIGHT", 0, 0, 0, 0},
    {(6 << 5) | (11), "DOWN", 0, 0, 0, 0},
    {(6 << 5) | (12), "NUM 0", 0, '0', 0, '0'},
    {(6 << 5) | (13), "NUM .", 0, '.', 0, '.'},
    // Special Key for PS/2 Keyboard start here
    {(7 << 5) | (0), "SCROLL LOCK", 0, 0, 0, 0},
    {(7 << 5) | (1), "MULT WWW SEARCH", 0, 0, 0, 0},
    {(7 << 5) | (2), "MULT PREV TRACK", 0, 0, 0, 0},
    {(7 << 5) | (3), "MULT WWW FAV", 0, 0, 0, 0},
    {(7 << 5) | (4), "MULT WWW REFRESH", 0, 0, 0, 0},
    {(7 << 5) | (4), "MULT MUTE", 0, 0, 0, 0},
    {(7 << 5) | (5), "SUPER RIGHT", 0, 0, 0, 0},
    {(7 << 5) | (6), "MULT WWW STOP", 0, 0, 0, 0},
    {(7 << 5) | (7), "MULT CALCULATOR", 0, 0, 0, 0},
    {(7 << 5) | (8), "APP KEY", 0, 0, 0, 0},
    {(7 << 5) | (9), "MULT FORWARD", 0, 0, 0, 0},
    {(7 << 5) | (10), "MULT PLAY/PAUSE", 0, 0, 0, 0},
    {(7 << 5) | (11), "ACPI POWER", 0, 0, 0, 0},
    {(7 << 5) | (12), "MULT BACK", 0, 0, 0, 0},
    {(7 << 5) | (13), "MULT WWW HOME", 0, 0, 0, 0},
    {(7 << 5) | (14), "MULT STOP", 0, 0, 0, 0},
    {(7 << 5) | (15), "ACPI SLEEP", 0, 0, 0, 0},
    {(7 << 5) | (16), "MULT MY COMPUTER", 0, 0, 0, 0},
    {(7 << 5) | (17), "MULT EMAIL", 0, 0, 0, 0},
    {(7 << 5) | (18), "MULT NEXT TRACK", 0, 0, 0, 0},
    {(7 << 5) | (19), "MULT SELECT", 0, 0, 0, 0},
    {(7 << 5) | (20), "ACPI WAKE", 0, 0, 0, 0},
    {(7 << 5) | (21), "HOME", 0, 0, 0, 0},
    {(7 << 5) | (22), "INSERT", 0, 0, 0, 0},
    {(7 << 5) | (23), "PAGE DOWN", 0, 0, 0, 0},
    {(7 << 5) | (24), "PAGE UP", 0, 0, 0, 0},
    {0b11111111, "UNKNOWN", 0, 0, 0, 0}
};

#define UNKNOWN_KEY 131

static const unsigned char scan_code_to_key_nbr[] = {
    [0x00] = UNKNOWN_KEY,
    [0x01] = 33-19,
    [0x02] = UNKNOWN_KEY,
    [0x03] = 29-19,
    [0x04] = 27-19,
    [0x05] = 25-19,
    [0x06] = 26-19,
    [0x07] = 36-19,
    [0x08] = UNKNOWN_KEY,
    [0x09] = 34-19,
    [0x0A] = 32-19,
    [0x0B] = 30-19,
    [0x0C] = 28-19,
    [0x0D] = 59-19,
    [0x0E] = 41-19,
    [0x0F] = UNKNOWN_KEY,
    [0x10] = UNKNOWN_KEY,
    [0x11] = 113-19,
    [0x12] = 93-19,
    [0x13] = UNKNOWN_KEY,
    [0x14] = 110-19,
    [0x15] = 60-19,
    [0x16] = 42-19,
    [0x17] = UNKNOWN_KEY,
    [0x18] = UNKNOWN_KEY,
    [0x19] = UNKNOWN_KEY,
    [0x1A] = 95-19,
    [0x1B] = 79-19,
    [0x1C] = 78-19,
    [0x1D] = 61-19,
    [0x1E] = 43-19,
    [0x1F] = UNKNOWN_KEY,
    [0x20] = UNKNOWN_KEY,
    [0x21] = 97-19,
    [0x22] = 96-19,
    [0x23] = 80-19,
    [0x24] = 62-19,
    [0x25] = 45-19,
    [0x26] = 44-19,
    [0x27] = UNKNOWN_KEY,
    [0x28] = UNKNOWN_KEY,
    [0x29] = 114-19,
    [0x2A] = 98-19,
    [0x2B] = 81-19,
    [0x2C] = 64-19,
    [0x2D] = 63-19,
    [0x2E] = 46-19,
    [0x2F] = UNKNOWN_KEY,
    [0x30] = UNKNOWN_KEY,
    [0x31] = 100-19,
    [0x32] = 99-19,
    [0x33] = 83-19,
    [0x34] = 82-19,
    [0x35] = 65-19,
    [0x36] = 47-19,
    [0x37] = UNKNOWN_KEY,
    [0x38] = UNKNOWN_KEY,
    [0x39] = UNKNOWN_KEY,
    [0x3A] = 101-19,
    [0x3B] = 84-19,
    [0x3C] = 66-19,
    [0x3D] = 48-19,
    [0x3E] = 49-19,
    [0x3F] = UNKNOWN_KEY,
    [0x40] = UNKNOWN_KEY,
    [0x41] = 102-19,
    [0x42] = 85-19,
    [0x43] = 67-19,
    [0x44] = 68-19,
    [0x45] = 51-19,
    [0x46] = 50-19,
    [0x47] = UNKNOWN_KEY,
    [0x48] = UNKNOWN_KEY,
    [0x49] = 103-19,
    [0x4A] = 104-19,
    [0x4B] = 86-19,
    [0x4C] = 87-19,
    [0x4D] = 69-19,
    [0x4E] = 52-19,
    [0x4F] = UNKNOWN_KEY,
    [0x50] = UNKNOWN_KEY,
    [0x51] = UNKNOWN_KEY,
    [0x52] = 88-19,
    [0x53] = UNKNOWN_KEY,
    [0x54] = 70-19,
    [0x55] = 53-19,
    [0x56] = UNKNOWN_KEY,
    [0x57] = UNKNOWN_KEY,
    [0x58] = 77-19,
    [0x59] = 105-19,
    [0x5A] = 89-19,
    [0x5B] = 71-19,
    [0x5C] = UNKNOWN_KEY,
    [0x5D] = 72-19,
    [0x5E] = UNKNOWN_KEY,
    [0x5F] = UNKNOWN_KEY,
    [0x60] = UNKNOWN_KEY,
    [0x61] = UNKNOWN_KEY,
    [0x62] = UNKNOWN_KEY,
    [0x63] = UNKNOWN_KEY,
    [0x64] = UNKNOWN_KEY,
    [0x65] = UNKNOWN_KEY,
    [0x66] = 54-19,
    [0x67] = UNKNOWN_KEY,
    [0x68] = UNKNOWN_KEY,
    [0x69] = 106-19,
    [0x6A] = UNKNOWN_KEY,
    [0x6B] = 90-19,
    [0x6C] = 73-19,
    [0x6D] = UNKNOWN_KEY,
    [0x6E] = UNKNOWN_KEY,
    [0x6F] = UNKNOWN_KEY,
    [0x70] = 122-19,
    [0x71] = 123-19,
    [0x72] = 107-19,
    [0x73] = 91-19,
    [0x74] = 92-19,
    [0x75] = 74-19,
    [0x76] = 24-19,
    [0x77] = 55-19,
    [0x78] = 35-19,
    [0x79] = 76-19,
    [0x7A] = 108-19,
    [0x7B] = 58-19,
    [0x7C] = 57-19,
    [0x7D] = 75-19,
    [0x7E] = 125-19-1,
    [0x7F] = UNKNOWN_KEY,
    [0x80] = UNKNOWN_KEY,
    [0x81] = UNKNOWN_KEY,
    [0x82] = UNKNOWN_KEY,
    [0x83] = 31-19
};

static const unsigned char scan_code_e0_to_key_nbr[] = {
    [0x00] = UNKNOWN_KEY,
    [0x01] = UNKNOWN_KEY,
    [0x02] = UNKNOWN_KEY,
    [0x03] = UNKNOWN_KEY,
    [0x04] = UNKNOWN_KEY,
    [0x05] = UNKNOWN_KEY,
    [0x06] = UNKNOWN_KEY,
    [0x07] = UNKNOWN_KEY,
    [0x08] = UNKNOWN_KEY,
    [0x09] = UNKNOWN_KEY,
    [0x0A] = UNKNOWN_KEY,
    [0x0B] = UNKNOWN_KEY,
    [0x0C] = UNKNOWN_KEY,
    [0x0D] = UNKNOWN_KEY,
    [0x0E] = UNKNOWN_KEY,
    [0x0F] = UNKNOWN_KEY,
    [0x10] = 126-19-1,
    [0x11] = 115-19,
    [0x12] = UNKNOWN_KEY,
    [0x13] = UNKNOWN_KEY,
    [0x14] = 117-19,
    [0x15] = 127-19-1, 
    [0x16] = UNKNOWN_KEY,
    [0x17] = UNKNOWN_KEY,
    [0x18] = 128-19-1, 
    [0x19] = UNKNOWN_KEY,
    [0x1A] = UNKNOWN_KEY,
    [0x1B] = UNKNOWN_KEY,
    [0x1C] = UNKNOWN_KEY,
    [0x1D] = UNKNOWN_KEY,
    [0x1E] = UNKNOWN_KEY,
    [0x1F] = 112-19, 
    [0x20] = 129-19-1, 
    [0x21] = 19-19, 
    [0x22] = UNKNOWN_KEY,
    [0x23] = 130-19-1,
    [0x24] = UNKNOWN_KEY,
    [0x25] = UNKNOWN_KEY,
    [0x26] = UNKNOWN_KEY,
    [0x27] = 131-19-1,
    [0x28] = 132-19-1,
    [0x29] = UNKNOWN_KEY,
    [0x2A] = UNKNOWN_KEY,
    [0x2B] = 133-19-1, 
    [0x2C] = UNKNOWN_KEY,
    [0x2D] = UNKNOWN_KEY,
    [0x2F] = 134-19-1,
    [0x30] = 135-19-1, 
    [0x31] = UNKNOWN_KEY,
    [0x32] = 20-19,
    [0x33] = UNKNOWN_KEY,
    [0x34] = 136-19-1,
    [0x35] = UNKNOWN_KEY,
    [0x36] = UNKNOWN_KEY,
    [0x37] = 137-19-1,
    [0x38] = 138-19-1,
    [0x39] = UNKNOWN_KEY,
    [0x3A] = 139-19-1,
    [0x3B] = 140-19-1,
    [0x3C] = UNKNOWN_KEY,
    [0x3D] = UNKNOWN_KEY,
    [0x3F] = 141-19-1,
    [0x40] = 142-19-1,
    [0x41] = UNKNOWN_KEY,
    [0x42] = UNKNOWN_KEY,
    [0x43] = UNKNOWN_KEY,
    [0x44] = UNKNOWN_KEY,
    [0x45] = UNKNOWN_KEY,
    [0x46] = UNKNOWN_KEY,
    [0x47] = UNKNOWN_KEY,
    [0x48] = 143-19-1, 
    [0x49] = UNKNOWN_KEY,
    [0x4A] = 46-19,
    [0x4B] = UNKNOWN_KEY,
    [0x4C] = UNKNOWN_KEY,
    [0x4D] = 144-19-1, 
    [0x4E] = UNKNOWN_KEY,
    [0x4F] = UNKNOWN_KEY,
    [0x50] = 145-19-1, 
    [0x51] = UNKNOWN_KEY,
    [0x52] = UNKNOWN_KEY,
    [0x53] = UNKNOWN_KEY,
    [0x54] = UNKNOWN_KEY,
    [0x55] = UNKNOWN_KEY,
    [0x56] = UNKNOWN_KEY,
    [0x57] = UNKNOWN_KEY,
    [0x58] = UNKNOWN_KEY,
    [0x59] = UNKNOWN_KEY,
    [0x5A] = 109-19,
    [0x5B] = UNKNOWN_KEY,
    [0x5C] = UNKNOWN_KEY,
    [0x5D] = UNKNOWN_KEY,
    [0x5E] = 146-19-1, 
    [0x5F] = UNKNOWN_KEY,
    [0x60] = UNKNOWN_KEY,
    [0x61] = UNKNOWN_KEY,
    [0x62] = UNKNOWN_KEY,
    [0x63] = UNKNOWN_KEY,
    [0x64] = UNKNOWN_KEY,
    [0x65] = UNKNOWN_KEY,
    [0x66] = UNKNOWN_KEY,
    [0x67] = UNKNOWN_KEY,
    [0x68] = UNKNOWN_KEY,
    [0x69] = 40-19,
    [0x6A] = UNKNOWN_KEY,
    [0x6B] = 118-19,
    [0x6C] = 147-19-1,
    [0x6D] = UNKNOWN_KEY,
    [0x6E] = UNKNOWN_KEY,
    [0x6F] = UNKNOWN_KEY,
    [0x70] = 148-19-1, 
    [0x71] = 37-19,
    [0x72] = 121-19,
    [0x73] = UNKNOWN_KEY,
    [0x74] = 120-19,
    [0x75] = 119-19,
    [0x76] = UNKNOWN_KEY,
    [0x77] = UNKNOWN_KEY,
    [0x78] = UNKNOWN_KEY,
    [0x79] = UNKNOWN_KEY,
    [0x7A] = 149-19-1,
    [0x7B] = UNKNOWN_KEY,
    [0x7C] = UNKNOWN_KEY,
    [0x7D] = 150-19-1,
};

#endif